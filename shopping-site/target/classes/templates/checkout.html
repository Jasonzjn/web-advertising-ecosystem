<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>结算 - 购物网站</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .ad-container {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            background-color: #f9f9f9;
            border-radius: 5px;
        }
        .ad-image {
            max-width: 100%;
            height: auto;
        }
        .checkout-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        .checkout-item-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            margin-right: 10px;
        }
        .checkout-item-details {
            flex-grow: 1;
        }
        .checkout-summary {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
        }
        .cart-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: #dc3545;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
        <a class="navbar-brand" th:text="${websiteName}">结算页面</a>
        <div class="navbar-nav ms-auto">
            <a class="nav-link" href="/products">商品</a>
            <a class="nav-link" href="/type/SPORT">运动</a>
            <a class="nav-link" href="/type/ELECTRONIC">电子</a>
            <a class="nav-link" href="/type/CLOTHING">服装</a>
            <a class="nav-link" href="/type/FOOD">食品</a>
            <a class="nav-link" href="/cart">购物车</a>
            <a class="nav-link" href="#">我的账户</a>
        </div>
    </div>
</nav>

<div class="container mt-4">
    <h1>订单结算</h1>

    <div class="row">
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header">
                    <h4>收货信息</h4>
                </div>
                <div class="card-body">
                    <form id="checkout-form">
                        <div class="mb-3">
                            <label for="recipientName" class="form-label">收货人姓名</label>
                            <input type="text" class="form-control" id="recipientName" required>
                        </div>
                        <div class="mb-3">
                            <label for="phone" class="form-label">联系电话</label>
                            <input type="tel" class="form-control" id="phone" required>
                        </div>
                        <div class="mb-3">
                            <label for="address" class="form-label">收货地址</label>
                            <textarea class="form-control" id="address" rows="3" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="deliveryTime" class="form-label">期望送达时间</label>
                            <input type="datetime-local" class="form-control" id="deliveryTime">
                        </div>
                    </form>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h4>支付方式</h4>
                </div>
                <div class="card-body">
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="radio" name="paymentMethod" id="alipay" value="alipay" checked>
                        <label class="form-check-label" for="alipay">支付宝</label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="radio" name="paymentMethod" id="wechat" value="wechat">
                        <label class="form-check-label" for="wechat">微信支付</label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="radio" name="paymentMethod" id="card" value="card">
                        <label class="form-check-label" for="card">银行卡</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="paymentMethod" id="cod" value="cod">
                        <label class="form-check-label" for="cod">货到付款</label>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h4>订单摘要</h4>
                </div>
                <div class="card-body">
                    <div class="checkout-item" th:each="item : ${cart.items}">
                        <img th:src="${item.product.imageUrl}" class="checkout-item-image" th:onerror="'https://via.placeholder.com/60'" alt="商品图片">
                        <div class="checkout-item-details">
                            <div th:text="${item.product.name}">商品名称</div>
                            <div class="text-muted">¥<span th:text="${item.product.price}">0.00</span> × <span th:text="${item.quantity}">1</span></div>
                        </div>
                        <div class="text-end">
                            ¥<span th:text="${#numbers.formatDecimal(item.subtotal, 0, 2)}">0.00</span>
                        </div>
                    </div>

                    <div class="checkout-summary mt-3">
                        <div class="d-flex justify-content-between">
                            <span>商品小计:</span>
                            <span>¥<span th:text="${#numbers.formatDecimal(cart.totalPrice, 0, 2)}">0.00</span></span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>运费:</span>
                            <span>¥0.00</span>
                        </div>
                        <div class="d-flex justify-content-between mt-2">
                            <strong>订单总计:</strong>
                            <strong>¥<span th:text="${#numbers.formatDecimal(cart.totalPrice, 0, 2)}">0.00</span></strong>
                        </div>
                    </div>

                    <button id="payButton" class="btn btn-success w-100 mt-3">确认支付</button>
                </div>
            </div>

            <h3 class="mt-4">相关广告</h3>
            <div id="ads-container">
                <!-- 广告将通过JavaScript加载 -->
            </div>
        </div>
    </div>
</div>

<script>
    // 从广告API获取广告数据
    fetch('/api/ads')
        .then(response => response.json())
        .then(ads => {
            const container = document.getElementById('ads-container');
            if(ads && ads.length > 0) {
                ads.forEach(ad => {
                    const adElement = document.createElement('div');
                    adElement.className = 'ad-container';
                    adElement.innerHTML = `
                        <a href="${ad.targetUrl}" target="_blank">
                            <img src="${ad.imageUrl}" alt="${ad.title}" class="ad-image">
                            <h5>${ad.title}</h5>
                            <p>${ad.content}</p>
                        </a>
                    `;
                    container.appendChild(adElement);
                });
            } else {
                container.innerHTML = '<p>暂无广告</p>';
            }
        })
        .catch(error => {
            console.error('获取广告失败:', error);
            document.getElementById('ads-container').innerHTML = '<p>广告加载失败</p>';
        });

    // 支付按钮事件
    document.getElementById('payButton').addEventListener('click', function() {
        // 获取表单数据
        const recipientName = document.getElementById('recipientName').value;
        const phone = document.getElementById('phone').value;
        const address = document.getElementById('address').value;
        const deliveryTime = document.getElementById('deliveryTime').value;
        const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;

        if (!recipientName || !phone || !address) {
            alert('请填写完整的收货信息！');
            return;
        }

        // 模拟支付处理
        this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 支付中...';
        this.disabled = true;

        // 模拟支付过程（2秒）
        setTimeout(function() {
            // 模拟支付成功
            if (confirm('支付模拟成功！是否确认提交订单？')) {
                // 使用POST请求提交订单
                fetch('/cart/process-checkout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        recipientName: recipientName,
                        phone: phone,
                        address: address,
                        deliveryTime: deliveryTime,
                        paymentMethod: paymentMethod
                    })
                })
                    .then(response => {
                        if (response.ok) {
                            // 解析响应数据，因为后端返回的是JSON
                            return response.json();
                        } else {
                            console.error('订单处理失败:', response.status);
                            alert('订单处理失败，请重试。');
                            document.getElementById('payButton').innerHTML = '确认支付';
                            document.getElementById('payButton').disabled = false;
                        }
                    })
                    .then(data => {
                        if(data && data.redirect) {
                            // 根据后端返回的重定向URL进行跳转
                            window.location.href = data.redirect;
                        } else {
                            // 如果没有重定向URL，可能是后端返回了视图而不是JSON
                            window.location.href = '/order-confirmation';
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('订单处理失败，请重试。');
                        document.getElementById('payButton').innerHTML = '确认支付';
                        document.getElementById('payButton').disabled = false;
                    });
            } else {
                document.getElementById('payButton').innerHTML = '确认支付';
                document.getElementById('payButton').disabled = false;
            }
        }, 2000);
    });
</script>
</body>
</html>